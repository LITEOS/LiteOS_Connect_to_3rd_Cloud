#ifndef ONENET_MQTT_BUFFER_H
#define ONENET_MQTT_BUFFER_H

#ifdef __cplusplus
extern "C" {
#endif

#include <stdint.h>
#include "config.h"

struct MqttExtent {
    uint32_t len;
    char *payload;

    struct MqttExtent *next;
};

struct MqttBuffer {
    struct MqttExtent *first_ext;
    struct MqttExtent *last_ext;
    uint32_t available_bytes;

    char **allocations;
    char *first_available;
    uint32_t alloc_count;
    uint32_t alloc_max_count;
    uint32_t buffered_bytes;
};

/**
 * ??????,??????????,??? @see MqttBuffer_Destroy??
 * @param buf ??????????
 */
void MqttBuffer_Init(struct MqttBuffer *buf);
/**
 * ???????
 * @param buf ?????????
 */
void MqttBuffer_Destroy(struct MqttBuffer *buf);
/**
 * ??(??)?????
 * @param buf ???(??)??????
 */
void MqttBuffer_Reset(struct MqttBuffer *buf);
/**
 * ?????????
 * @param buf ???????????????
 * @param size ??????????(???)
 */
struct MqttExtent *MqttBuffer_AllocExtent(struct MqttBuffer *buf, uint32_t size);
/**
 * ???????????????
 * @param buf ???????????
 * @param payload ???????
 * @param size ??????(???)
 * @param own ?0?,???????????,?0?,?????????
 * @return ????? MQTTERR_NOERROR
 * @remark ?own?0?,????payload?buf?????????
 */
int MqttBuffer_Append(struct MqttBuffer *buf, char *payload, uint32_t size, int own);
/**
 * ?????????????????
 * @param buf ???????????
 * @param ext ???????????
 * @remark ?ext??buf???,????ext?buf????????
 */
void MqttBuffer_AppendExtent(struct MqttBuffer *buf, struct MqttExtent *ext);

#ifdef __cplusplus
} // extern "C"
#endif

#endif // ONENET_MQTT_BUFFER_H
